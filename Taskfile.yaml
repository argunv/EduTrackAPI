version: "3"

vars:
  COMPOSE_FILE: docker-compose.yml

tasks:
  up:
    desc: "Поднять все сервисы для разработки"
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} up --build -d

  down:
    desc: "Остановить и очистить сервисы"
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} down -v

  db:migrate:
    desc: "Применить миграции базы"
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} run --rm migrator alembic upgrade head

  test:
    desc: "Запустить тесты с покрытием"
    cmds:
      - poetry run pytest --cov=edutrack --cov-report=term-missing

  logs:
    desc: "Показать логи API и notifier"
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} logs -f api notifier

  save-logs:
    desc: "Экспорт логов сервисов в конец файла docker-compose.log"
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} logs >> docker-compose.log
      - echo "Логи сервисов сохранены в конец файла ./docker-compose.log"

  clear-logs:
    desc: "Очистить файл docker-compose.log"
    cmds:
      - >
        echo "" > docker-compose.log
      - echo "Файл docker-compose.log очищен"

  lint:
    desc: "Запустить все линтеры"
    cmds:
      - poetry run ruff check src/ tests/
      - poetry run flake8 src/ tests/
      - poetry run mypy src/ --ignore-missing-imports || true

  lint-fix:
    desc: "Исправить проблемы линтеров автоматически"
    cmds:
      - poetry run ruff check --fix src/ tests/

  security:
    desc: "Проверить безопасность кода"
    cmds:
      - poetry run bandit -r src/ -f json -o bandit-report.json
      - poetry run safety scan --json || true

  ci:
    desc: "Запустить все проверки (линтеры, тесты, безопасность)"
    cmds:
      - task: lint
      - task: test
      - task: security

  create-superuser:
    desc: "Создать суперпользователя"
    cmds:
      - poetry run python -m scripts.create_admin

  load-demo:
    desc: "Загрузить демонстрационные данные из SQL файла (нужен psql для запуска)"
    cmds:
      - sh ./scripts/load_demo.sh

  demo:email:
    desc: "Запустить демонстрацию работы email сервисов"
    cmds:
      - poetry run python scripts/demo/demo_smtp.py